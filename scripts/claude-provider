#!/bin/bash

# claude-provider - Portable Claude Code provider switcher
# Based on Chronicle's claude-provider implementation

set -e

# Configuration
CLAUDE_SETTINGS_FILE="$HOME/.claude/settings.json"
BACKUP_DIR="$HOME/.claude/backups"
CONFIG_FILE="$HOME/.claude-provider-config.yaml"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Initialize config file if it doesn't exist
init_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
# Claude Provider Configuration
current_provider: "anthropic"
providers:
  anthropic:
    type: "oauth"
    description: "Official Anthropic Claude Code (OAuth)"
  zai:
    type: "api_key"
    description: "Z.AI proxy (3x usage at lower cost)"
    api_key: null
    base_url: "https://api.z.ai/api/anthropic"
    timeout_ms: 3000000
EOF
        log_info "Created default configuration at $CONFIG_FILE"
    fi
}

# Backup current settings
backup_settings() {
    if [[ -f "$CLAUDE_SETTINGS_FILE" ]]; then
        local timestamp=$(date +"%Y%m%d_%H%M%S")
        local backup_file="$BACKUP_DIR/settings_$timestamp.json"
        cp "$CLAUDE_SETTINGS_FILE" "$backup_file"
        log_info "Backup created: $backup_file"
        echo "$backup_file"
    else
        log_warning "No settings file found to backup"
        echo ""
    fi
}

# Detect current provider
detect_current_provider() {
    if [[ -f "$CLAUDE_SETTINGS_FILE" ]]; then
        if grep -q "api.z.ai/api/anthropic" "$CLAUDE_SETTINGS_FILE"; then
            echo "zai"
        else
            echo "anthropic"
        fi
    else
        echo "anthropic"
    fi
}

# Read current provider from config
get_current_provider() {
    init_config
    if [[ -f "$CONFIG_FILE" ]]; then
        grep "^current_provider:" "$CONFIG_FILE" | awk '{print $2}' | tr -d '"'
    else
        echo "anthropic"
    fi
}

# Update current provider in config
set_current_provider() {
    local provider="$1"
    init_config
    sed -i.bak "s/^current_provider:.*/current_provider: \"$provider\"/" "$CONFIG_FILE"
    rm -f "$CONFIG_FILE.bak"
}

# List available providers
list_providers() {
    init_config
    echo "Available providers:"
    echo "  anthropic  - Official Anthropic Claude Code (OAuth)"
    echo "  zai        - Z.AI proxy (3x usage at lower cost)"
    echo
    echo "Current provider: $(get_current_provider)"
}

# Show current provider
show_current() {
    local current=$(detect_current_provider)
    local config_current=$(get_current_provider)

    echo "Provider Information:"
    echo "  Detected from settings: $current"
    echo "  Configured current:      $config_current"
    echo

    if [[ "$current" == "zai" ]]; then
        echo "Z.AI Configuration:"
        echo "  Base URL: https://api.z.ai/api/anthropic"
        echo "  Models: GLM-4.5-air (Haiku), GLM-4.7 (Sonnet/Opus)"
    else
        echo "Anthropic Configuration:"
        echo "  Authentication: OAuth"
        echo "  Models: Default Claude models"
    fi
}

# Setup Z.AI API key
setup_zai() {
    echo -n "Enter Z.AI API key: "
    read -s api_key
    echo
    echo -n "Confirm API key: "
    read -s api_key_confirm
    echo

    if [[ "$api_key" != "$api_key_confirm" ]]; then
        log_error "API keys do not match"
        exit 1
    fi

    if [[ -z "$api_key" ]]; then
        log_error "API key cannot be empty"
        exit 1
    fi

    init_config
    # Update config with API key
    sed -i.bak "s/api_key: null/api_key: \"$api_key\"/" "$CONFIG_FILE"
    rm -f "$CONFIG_FILE.bak"

    log_success "Z.AI API key configured successfully"
    echo "Use 'claude-provider use zai' to switch to Z.AI provider"
}

# Switch to a provider
use_provider() {
    local provider="$1"
    local backup_file=$(backup_settings)

    case "$provider" in
        "anthropic")
            log_info "Switching to Anthropic provider..."

            # Create settings file or modify existing
            if [[ -f "$CLAUDE_SETTINGS_FILE" ]]; then
                # Remove all Z.AI-specific env vars completely
                jq 'if .env then del(.env) else . end' "$CLAUDE_SETTINGS_FILE" > "$CLAUDE_SETTINGS_FILE.tmp" && \
                mv "$CLAUDE_SETTINGS_FILE.tmp" "$CLAUDE_SETTINGS_FILE"
            else
                # Create minimal settings file
                echo '{}' > "$CLAUDE_SETTINGS_FILE"
            fi

            set_current_provider "anthropic"
            log_success "Switched to Anthropic provider"
            log_info "Restart Claude Code to apply changes"
            ;;

        "zai")
            # Check if API key is configured
            init_config
            local api_key=$(grep "api_key:" "$CONFIG_FILE" | grep -v "type:" | awk '{print $2}' | tr -d '"')

            if [[ "$api_key" == "null" || -z "$api_key" ]]; then
                log_error "Z.AI API key not configured. Run 'claude-provider setup zai' first"
                exit 1
            fi

            log_info "Switching to Z.AI provider..."

            # Create or update settings file with Z.AI configuration
            if [[ -f "$CLAUDE_SETTINGS_FILE" ]]; then
                # Update existing file with Z.AI settings
                # Note: Z.AI uses different model names (glm-4.5-air, glm-4.6) via ANTHROPIC_DEFAULT_*_MODEL
                # Do NOT set CLAUDE_CODE_SUBAGENT_MODEL as it's not compatible with Z.AI's model naming
                jq '.env = {
                    "ANTHROPIC_AUTH_TOKEN": "'$api_key'",
                    "ANTHROPIC_BASE_URL": "https://api.z.ai/api/anthropic",
                    "API_TIMEOUT_MS": "3000000",
                    "ANTHROPIC_DEFAULT_HAIKU_MODEL": "glm-4.5-air",
                    "ANTHROPIC_DEFAULT_SONNET_MODEL": "glm-4.7",
                    "ANTHROPIC_DEFAULT_OPUS_MODEL": "glm-4.7"
                }' "$CLAUDE_SETTINGS_FILE" > "$CLAUDE_SETTINGS_FILE.tmp" && \
                mv "$CLAUDE_SETTINGS_FILE.tmp" "$CLAUDE_SETTINGS_FILE"
            else
                # Create new settings file
                cat > "$CLAUDE_SETTINGS_FILE" << EOF
{
  "env": {
    "ANTHROPIC_AUTH_TOKEN": "$api_key",
    "ANTHROPIC_BASE_URL": "https://api.z.ai/api/anthropic",
    "API_TIMEOUT_MS": "3000000",
    "ANTHROPIC_DEFAULT_HAIKU_MODEL": "glm-4.5-air",
    "ANTHROPIC_DEFAULT_SONNET_MODEL": "glm-4.7",
    "ANTHROPIC_DEFAULT_OPUS_MODEL": "glm-4.7"
  }
}
EOF
            fi

            set_current_provider "zai"
            log_success "Switched to Z.AI provider"
            log_info "Restart Claude Code to apply changes"
            ;;

        *)
            log_error "Unknown provider: $provider"
            echo "Available providers: anthropic, zai"
            exit 1
            ;;
    esac
}

# List backups
list_backups() {
    if [[ -d "$BACKUP_DIR" ]]; then
        echo "Available backups:"
        ls -la "$BACKUP_DIR/settings_*.json" 2>/dev/null | awk '{print $9}' | sed 's|^.*/||' | while read file; do
            echo "  $file"
        done
    else
        log_info "No backup directory found"
    fi
}

# Restore from backup
restore_backup() {
    local backup_name="$1"
    local backup_file="$BACKUP_DIR/$backup_name"

    if [[ ! -f "$backup_file" ]]; then
        backup_file="$BACKUP_DIR/settings_$backup_name.json"
    fi

    if [[ ! -f "$backup_file" ]]; then
        log_error "Backup not found: $backup_name"
        echo "Available backups:"
        list_backups
        exit 1
    fi

    log_info "Restoring from backup: $backup_file"
    backup_settings
    cp "$backup_file" "$CLAUDE_SETTINGS_FILE"
    log_success "Settings restored from backup"
    log_info "Restart Claude Code to apply changes"
}

# Show help
show_help() {
    cat << 'EOF'
claude-provider - Portable Claude Code provider switcher

USAGE:
    claude-provider <command> [args]

COMMANDS:
    list                    List available providers
    current                 Show current provider and configuration
    use <provider>          Switch to specified provider (anthropic|zai)
    setup <provider>        Configure provider (currently only: zai)
    backups                 List available backups
    restore <backup>        Restore settings from backup
    help                    Show this help message

EXAMPLES:
    claude-provider list
    claude-provider current
    claude-provider use zai
    claude-provider use anthropic
    claude-provider setup zai
    claude-provider restore settings_20231107_143022.json

PROVIDERS:
    anthropic    Official Anthropic Claude Code (OAuth)
    zai          Z.AI proxy (3x usage at lower cost)

Files:
    ~/.claude/settings.json          Claude Code settings
    ~/.claude-provider-config.yaml  Provider configuration
    ~/.claude/backups/              Settings backups
EOF
}

# Check dependencies
check_dependencies() {
    if ! command -v jq &> /dev/null; then
        log_error "jq is required but not installed"
        log_info "Install jq: brew install jq (macOS) or pkg install jq (FreeBSD)"
        exit 1
    fi
}

# Main function
main() {
    check_dependencies

    case "${1:-help}" in
        "list")
            list_providers
            ;;
        "current")
            show_current
            ;;
        "use")
            if [[ -z "${2:-}" ]]; then
                log_error "Provider name required"
                echo "Usage: claude-provider use <provider>"
                echo "Available providers: anthropic, zai"
                exit 1
            fi
            use_provider "$2"
            ;;
        "setup")
            if [[ -z "${2:-}" ]]; then
                log_error "Provider name required"
                echo "Usage: claude-provider setup <provider>"
                echo "Currently supported: zai"
                exit 1
            fi
            case "$2" in
                "zai")
                    setup_zai
                    ;;
                *)
                    log_error "Setup not supported for provider: $2"
                    echo "Currently supported: zai"
                    exit 1
                    ;;
            esac
            ;;
        "backups")
            list_backups
            ;;
        "restore")
            if [[ -z "${2:-}" ]]; then
                log_error "Backup name required"
                echo "Usage: claude-provider restore <backup>"
                echo "Available backups:"
                list_backups
                exit 1
            fi
            restore_backup "$2"
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        *)
            log_error "Unknown command: $1"
            echo "Use 'claude-provider help' for usage information"
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"